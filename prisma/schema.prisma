// Prisma schema file - YottaErp
// Database schema con regole ERP: Decimal per valori monetari, Snapshot per documenti
// 
// ðŸ“š DOCUMENTAZIONE ANTI-AMNESIA:
// - SEMPRE usare Decimal per valori monetari (MAI number)
// - Documenti immutabili con snapshot (MAI JOIN per dati storici)
// - Giacenza calcolata da movimenti (MAI campo stock statico)
// - MULTITENANT: Ogni tabella ha organizationId per isolamento dati

generator client {
  provider   = "prisma-client-js"
  engineType = "library" // âœ… Usa library engine (tradizionale) per compatibilitÃ  Supabase
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// AUTENTICAZIONE - UTENTI
// ============================================================================

/**
 * User: Utente del sistema (Authentication)
 * GESTIONE AUTENTICAZIONE:
 * - Email/Password con hash bcrypt
 * - Super Admin flag per accesso God Page
 * - Relazione Many-to-Many con Organizations tramite UserOrganization
 */
model User {
  id String @id @default(cuid())

  // Credenziali
  email        String @unique
  passwordHash String // âœ… Hash bcrypt (MAI salvare password in chiaro!)

  // Dati personali
  firstName String?
  lastName  String?
  phone     String?
  avatar    String? // URL avatar/foto profilo

  // Super Admin (accesso God Page /organizations)
  isSuperAdmin Boolean @default(false)

  // Account status
  active        Boolean @default(true)
  emailVerified Boolean @default(false)

  // Password reset
  resetToken    String?   @unique
  resetTokenExp DateTime?

  // Last login tracking
  lastLoginAt DateTime?
  lastLoginIp String?

  // Timestamp
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relazioni
  organizations UserOrganization[]

  @@index([email])
  @@index([isSuperAdmin])
}

// ============================================================================
// MULTITENANT - ORGANIZZAZIONI
// ============================================================================

/**
 * Organization: Organizzazione/Azienda (Multitenant)
 * REGOLA MULTITENANT:
 * - Ogni organizzazione Ã¨ completamente isolata dalle altre
 * - Tutti i dati (clienti, prodotti, documenti, magazzino) appartengono a un'organizzazione
 * - Gli utenti possono appartenere a piÃ¹ organizzazioni (con ruoli diversi)
 */
model Organization {
  id String @id @default(cuid())

  // Dati azienda
  businessName String // Ragione sociale dell'azienda ERP
  vatNumber    String? @unique // P.IVA dell'azienda
  fiscalCode   String? // Codice Fiscale

  // Indirizzo sede legale
  address  String?
  city     String?
  province String?
  zipCode  String?
  country  String  @default("IT")

  // Contatti
  email   String?
  pec     String?
  phone   String?
  sdiCode String? // Codice SDI per fatturazione elettronica

  // Logo e branding
  logoUrl String?

  // Subscription e limiti
  plan               String @default("FREE") // FREE, BASIC, PREMIUM
  maxUsers           Int    @default(5)
  maxInvoicesPerYear Int    @default(500)

  // Metadata
  active Boolean @default(true)

  // Timestamp
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relazioni (tutte le entitÃ  appartengono a un'organizzazione)
  users          UserOrganization[] // Utenti con accesso a questa org
  entities       Entity[]
  products       Product[]
  warehouses     Warehouse[]
  documents      Document[]
  vatRates       VatRate[]
  stockMovements StockMovement[]

  @@index([businessName])
}

/**
 * UserOrganization: Join table per relazione User-Organization (Many-to-Many)
 * Un utente puÃ² appartenere a piÃ¹ organizzazioni con ruoli diversi
 */
model UserOrganization {
  id String @id @default(cuid())

  userId         String
  organizationId String

  // Ruolo utente in questa organizzazione
  role UserRole @default(USER)

  // Timestamp
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relazioni
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId]) // Un utente puÃ² avere un solo ruolo per org
  @@index([userId])
  @@index([organizationId])
}

enum UserRole {
  OWNER // Proprietario (accesso completo)
  ADMIN // Amministratore (quasi tutto)
  USER // Utente standard (operazioni quotidiane)
  READONLY // Solo lettura (report, visualizzazione)
}

// ============================================================================
// ANAGRAFICHE UNIFICATE (Cliente/Fornitore)
// ============================================================================

/**
 * Entity: Anagrafica unificata per Clienti e Fornitori
 * REGOLA: Un'entitÃ  puÃ² essere CLIENT, PROVIDER o BOTH
 * I documenti fanno SNAPSHOT di questi dati (non dipendono da relazioni)
 * MULTITENANT: Ogni entitÃ  appartiene a un'organizzazione
 */
model Entity {
  id String @id @default(cuid())

  // âœ… MULTITENANT: Ogni entitÃ  appartiene a un'organizzazione
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Tipologia entitÃ 
  type EntityType // CLIENT, PROVIDER, BOTH

  // Flag per distinguere LEAD da CLIENT (entrambi sono CLIENT nel database)
  isLead Boolean @default(false)

  // Dati anagrafici
  businessName String // Ragione sociale
  vatNumber    String? // P.IVA italiana (11 cifre)
  fiscalCode   String? // Codice Fiscale (16 caratteri)

  // Indirizzo (tutti opzionali, solo ragione sociale obbligatoria)
  address  String?
  city     String?
  province String? // 2 caratteri (es. MI, RM)
  zipCode  String? // CAP (5 cifre)
  country  String  @default("IT")

  // Contatti
  email   String?
  pec     String? // PEC (Posta Elettronica Certificata)
  phone   String?
  sdiCode String? // Codice SDI per fatturazione elettronica (7 caratteri)

  // IVA predefinita per questa entitÃ 
  vatRateId      String? // Aliquota IVA di default
  defaultVatRate VatRate? @relation(fields: [vatRateId], references: [id])

  // Metadata
  notes  String? @db.Text
  active Boolean @default(true)

  // Timestamp
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relazioni (opzionali, i documenti hanno snapshot)
  documents Document[]

  @@unique([organizationId, vatNumber]) // P.IVA unica per organizzazione
  @@index([organizationId])
  @@index([organizationId, businessName])
  @@index([organizationId, type])
  @@index([organizationId, type, isLead]) // Ottimizza query filtro per tipo con isLead
}

enum EntityType {
  CLIENT // Solo cliente
  PROVIDER // Solo fornitore
  BOTH // Cliente e fornitore
}

// ============================================================================
// ALIQUOTE IVA
// ============================================================================

/**
 * VatRate: Aliquote IVA configurabili
 * REGOLA: Ogni documento fa SNAPSHOT del valore, ma mantiene relazione per ricerca
 * Esempi: 22%, 10%, 4%, 0% (esente)
 * MULTITENANT: Ogni organizzazione puÃ² avere le proprie aliquote
 */
model VatRate {
  id String @id @default(cuid())

  // âœ… MULTITENANT: Ogni aliquota appartiene a un'organizzazione
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name        String // Es. "Standard 22%", "Ridotta 10%", "Esente"
  value       Decimal @db.Decimal(5, 4) // Es. 0.2200 per 22%
  description String? @db.Text

  // Metadata
  active    Boolean @default(true)
  isDefault Boolean @default(false) // Una sola aliquota di default per org

  // Timestamp
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relazioni
  documentLines DocumentLine[]
  entities      Entity[]

  @@unique([organizationId, name]) // Nome aliquota unico per organizzazione
  @@index([organizationId])
  @@index([organizationId, isDefault])
}

// ============================================================================
// PRODOTTI
// ============================================================================

/**
 * Product: Anagrafica prodotti/servizi
 * REGOLA IMPORTANTE: NESSUN campo 'stock'!
 * La giacenza si calcola sommando algebricamente i StockMovement
 * MULTITENANT: Ogni prodotto appartiene a un'organizzazione
 */
model Product {
  id String @id @default(cuid())

  // âœ… MULTITENANT: Ogni prodotto appartiene a un'organizzazione
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  code        String // Codice articolo
  name        String
  description String? @db.Text

  // Prezzi e IVA (SEMPRE Decimal per valori monetari!)
  price Decimal @db.Decimal(12, 2) // Prezzo di listino

  // IVA predefinita per questo prodotto
  vatRateId String? // Aliquota IVA di default

  // Note: NESSUN campo 'stock' qui!
  // La giacenza Ã¨ calcolata da StockMovement (Calculated Stock Rule)

  // Metadata
  active Boolean @default(true)

  // Timestamp
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relazioni
  stockMovements StockMovement[]
  documentLines  DocumentLine[]

  @@unique([organizationId, code]) // Codice prodotto unico per organizzazione
  @@index([organizationId])
  @@index([organizationId, name])
}

// ============================================================================
// MAGAZZINO (Calculated Stock)
// ============================================================================

/**
 * Warehouse: Magazzini fisici
 * MULTITENANT: Ogni magazzino appartiene a un'organizzazione
 */
model Warehouse {
  id String @id @default(cuid())

  // âœ… MULTITENANT: Ogni magazzino appartiene a un'organizzazione
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  code    String // Codice magazzino
  name    String
  address String?

  // Timestamp
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relazioni
  stockMovements StockMovement[]

  @@unique([organizationId, code]) // Codice magazzino unico per organizzazione
  @@index([organizationId])
}

/**
 * StockMovement: Movimenti di magazzino
 * REGOLA FONDAMENTALE: La giacenza NON Ã¨ un campo, ma la SOMMA di questi movimenti
 * - quantity > 0 = CARICO
 * - quantity < 0 = SCARICO
 * La giacenza attuale si ottiene: SUM(quantity) GROUP BY (productId, warehouseId)
 * MULTITENANT: Ogni movimento appartiene a un'organizzazione
 */
model StockMovement {
  id String @id @default(cuid())

  // âœ… MULTITENANT: Ogni movimento appartiene a un'organizzazione
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  productId   String
  warehouseId String

  // QuantitÃ  algebrica (+ per carichi, - per scarichi)
  quantity Decimal @db.Decimal(12, 4)

  // Tipo movimento
  type MovementType

  // Documento origine (per tracciabilitÃ )
  documentType   DocumentType? // Riferimento al tipo di documento
  documentId     String? // ID del documento origine
  documentNumber String? // Numero documento per ricerca

  // Metadata
  notes  String? @db.Text
  userId String? // Chi ha fatto il movimento

  // Timestamp
  createdAt DateTime @default(now())

  // Relazioni
  product   Product   @relation(fields: [productId], references: [id])
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])

  @@index([organizationId])
  @@index([organizationId, productId])
  @@index([organizationId, warehouseId])
  @@index([organizationId, createdAt])
  @@index([organizationId, documentId])
}

enum MovementType {
  CARICO_INIZIALE // Carico iniziale inventario
  CARICO_FORNITORE // Acquisto da fornitore
  SCARICO_VENDITA // Vendita con fattura
  SCARICO_DDT // Scarico con DDT
  RETTIFICA_INVENTARIO // Rettifica da inventario fisico
  RESO_CLIENTE // Reso da cliente (carico)
  RESO_FORNITORE // Reso a fornitore (scarico)
  TRASFERIMENTO_USCITA // Trasferimento tra magazzini (uscita)
  TRASFERIMENTO_ENTRATA // Trasferimento tra magazzini (entrata)
}

// ============================================================================
// DOCUMENTI (con Snapshot Rule)
// ============================================================================

/**
 * Document: Documento commerciale unificato
 * REGOLA SNAPSHOT: Tutti i dati del cliente sono COPIATI (snapshot) al momento
 * della creazione. Se domani il cliente cambia indirizzo, questo documento
 * mantiene l'indirizzo originale.
 * IMPORTANTE: Supporta piÃ¹ tipi di documento (preventivo, ordine, DDT, fattura, nota credito)
 * MULTITENANT: Ogni documento appartiene a un'organizzazione
 */
model Document {
  id String @id @default(cuid())

  // âœ… MULTITENANT: Ogni documento appartiene a un'organizzazione
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Tipo documento
  type DocumentType // QUOTE, ORDER, DELIVERY_NOTE, INVOICE, CREDIT_NOTE

  number String // Numero documento progressivo
  date   DateTime

  // SNAPSHOT FISCALE dell'entitÃ  al momento del documento
  // âœ… Questi dati sono IMMUTABILI e indipendenti dall'anagrafica
  entityId                   String? // Riferimento opzionale per statistiche
  customerNameSnapshot       String // âœ… Ragione sociale al momento
  customerVatSnapshot        String? // âœ… P.IVA al momento
  customerFiscalCodeSnapshot String? // âœ… Codice Fiscale al momento
  customerAddressSnapshot    String // âœ… Indirizzo completo al momento
  customerSdiSnapshot        String? // âœ… Codice SDI al momento
  customerCity               String // âœ… CittÃ  al momento
  customerProvince           String // âœ… Provincia al momento
  customerZip                String // âœ… CAP al momento
  customerCountry            String  @default("IT")

  // Totali documento (tutti Decimal per precisione fiscale)
  netTotal   Decimal @db.Decimal(12, 2) // Imponibile totale
  vatTotal   Decimal @db.Decimal(12, 2) // IVA totale
  grossTotal Decimal @db.Decimal(12, 2) // Totale lordo

  // Metadata
  notes        String? @db.Text
  paymentTerms String? // Condizioni di pagamento

  // Timestamp
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relazioni
  lines  DocumentLine[]
  entity Entity?        @relation(fields: [entityId], references: [id])

  @@unique([organizationId, number]) // Numero documento unico per organizzazione
  @@index([organizationId])
  @@index([organizationId, date])
  @@index([organizationId, entityId])
  @@index([organizationId, type])
}

enum DocumentType {
  QUOTE // Preventivo
  ORDER // Ordine
  DELIVERY_NOTE // DDT (Documento di Trasporto)
  INVOICE // Fattura
  CREDIT_NOTE // Nota di credito
}

/**
 * DocumentLine: Riga di documento
 * REGOLA SNAPSHOT: Anche qui, TUTTI i dati del prodotto sono copiati.
 * Se domani il prezzo del prodotto cambia, questa riga mantiene il prezzo originale.
 */
model DocumentLine {
  id         String @id @default(cuid())
  documentId String

  // SNAPSHOT del prodotto al momento del documento
  productId   String? // Riferimento opzionale per statistiche
  productCode String // âœ… Codice articolo al momento
  description String // âœ… Descrizione al momento
  unitPrice   Decimal @db.Decimal(12, 2) // âœ… Prezzo unitario al momento
  quantity    Decimal @db.Decimal(12, 4)

  // SNAPSHOT dell'IVA (con relazione per ricerca)
  vatRateId String? // Riferimento all'aliquota IVA
  vatRate   Decimal @db.Decimal(5, 4) // âœ… Valore aliquota IVA al momento (snapshot)

  // Campi calcolati (denormalizzati per performance)
  netAmount   Decimal @db.Decimal(12, 2) // quantity * unitPrice
  vatAmount   Decimal @db.Decimal(12, 2) // netAmount * vatRate
  grossAmount Decimal @db.Decimal(12, 2) // netAmount + vatAmount

  // Timestamp
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relazioni
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  product    Product? @relation(fields: [productId], references: [id])
  vatRateRef VatRate? @relation(fields: [vatRateId], references: [id])

  @@index([documentId])
  @@index([productId])
  @@index([vatRateId])
}
