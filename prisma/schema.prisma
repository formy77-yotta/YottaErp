generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// *
///  * User: Utente del sistema (Authentication)
///  * GESTIONE AUTENTICAZIONE:
///  * - Email/Password con hash bcrypt
///  * - Super Admin flag per accesso God Page
///  * - Relazione Many-to-Many con Organizations tramite UserOrganization
model User {
  id            String             @id @default(cuid())
  email         String             @unique
  passwordHash  String
  firstName     String?
  lastName      String?
  phone         String?
  avatar        String?
  isSuperAdmin  Boolean            @default(false)
  active        Boolean            @default(true)
  emailVerified Boolean            @default(false)
  resetToken    String?            @unique
  resetTokenExp DateTime?
  lastLoginAt   DateTime?
  lastLoginIp   String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  organizations UserOrganization[]

  @@index([email])
  @@index([isSuperAdmin])
}

/// *
///  * Organization: Organizzazione/Azienda (Multitenant)
///  * REGOLA MULTITENANT:
///  * - Ogni organizzazione è completamente isolata dalle altre
///  * - Tutti i dati (clienti, prodotti, documenti, magazzino) appartengono a un'organizzazione
///  * - Gli utenti possono appartenere a più organizzazioni (con ruoli diversi)
model Organization {
  id                  String               @id @default(cuid())
  businessName        String
  vatNumber           String?              @unique
  fiscalCode          String?
  address             String?
  city                String?
  province            String?
  zipCode             String?
  country             String               @default("IT")
  email               String?
  pec                 String?
  phone               String?
  sdiCode             String?
  logoUrl             String?
  
  // ✅ Iscrizione REA (Registro Imprese) - Obbligatorio per società iscritte (art. 2250 CC)
  reaUfficio          String?              // Ufficio REA (es. "RM", "MI")
  reaNumero           String?              // Numero REA
  reaCapitaleSociale  Decimal?             @db.Decimal(15, 2) // Capitale sociale in euro
  
  // ✅ Regime Fiscale (obbligatorio per fatturazione elettronica)
  regimeFiscale       String?              @default("RF01") // RF01=Ordinario, RF02=Minimi, etc.
  
  // ✅ Parametri organizzazione
  fiscalYear          Int?                 // Anno contabile (es. 2025)
  
  plan                String               @default("FREE")
  maxUsers            Int                  @default(5)
  maxInvoicesPerYear  Int                  @default(500)
  active              Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  documents           Document[]
  documentTypeConfigs DocumentTypeConfig[]
  entities            Entity[]
  products            Product[]
  productCategories   ProductCategory[]
  productTypes        ProductType[]
  stockMovements      StockMovement[]
  unitsOfMeasure      UnitOfMeasure[]
  users               UserOrganization[]
  vatRates            VatRate[]
  warehouses          Warehouse[]
  paymentTypes        PaymentType[]
  paymentConditions   PaymentCondition[]

  @@index([businessName])
}

/// *
///  * UserOrganization: Join table per relazione User-Organization (Many-to-Many)
///  * Un utente può appartenere a più organizzazioni con ruoli diversi
model UserOrganization {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           UserRole     @default(USER)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

/// *
///  * Entity: Anagrafica unificata per Clienti e Fornitori
///  * REGOLA: Un'entità può essere CLIENT, PROVIDER o BOTH
///  * I documenti fanno SNAPSHOT di questi dati (non dipendono da relazioni)
///  * MULTITENANT: Ogni entità appartiene a un'organizzazione
model Entity {
  id             String       @id @default(cuid())
  organizationId String
  type           EntityType
  isLead         Boolean      @default(false)
  businessName   String
  vatNumber      String?
  fiscalCode     String?
  address        String?
  city           String?
  province       String?
  zipCode        String?
  country        String       @default("IT")
  email          String?
  pec            String?
  phone          String?
  sdiCode        String?
  vatRateId      String?
  notes          String?
  active         Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  documents      Document[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  defaultVatRate VatRate?     @relation(fields: [vatRateId], references: [id])

  @@unique([organizationId, vatNumber])
  @@index([organizationId])
  @@index([organizationId, businessName])
  @@index([organizationId, type])
  @@index([organizationId, type, isLead])
}

/// *
///  * VatRate: Aliquote IVA configurabili
///  * REGOLA: Ogni documento fa SNAPSHOT del valore, ma mantiene relazione per ricerca
///  * Esempi: 22%, 10%, 4%, 0% (esente)
///  * MULTITENANT: Ogni organizzazione può avere le proprie aliquote
model VatRate {
  id             String         @id @default(cuid())
  organizationId String
  name           String
  value          Decimal        @db.Decimal(5, 4)
  nature         String?
  description    String?
  active         Boolean        @default(true)
  isDefault      Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  documentLines  DocumentLine[]
  entities       Entity[]
  products       Product[]
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([organizationId, isDefault])
}

/// *
///  * ProductCategory: Categorie articoli
///  * 
///  * Tabella di database (non enum) per permettere estensioni future.
///  * MULTITENANT: Ogni categoria appartiene a un'organizzazione
model ProductCategory {
  id             String       @id @default(cuid())
  organizationId String
  code           String
  description    String
  active         Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  products       Product[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([organizationId, active])
}

/// *
///  * ProductType: Tipologie articoli
///  * 
///  * Gestisce le tipologie di articoli (es. Materiali, Servizi, Finiture).
///  * Contiene il flag per la gestione magazzino.
///  * MULTITENANT: Ogni tipologia appartiene a un'organizzazione
model ProductType {
  id             String       @id @default(cuid())
  organizationId String
  code           String
  description    String
  manageStock    Boolean      @default(true)
  
  // Flag visibilità prodotti in base al tipo documento
  // Determina se i prodotti di questa tipologia sono visibili quando si crea un documento
  visibleInPurchase Boolean @default(true) // Visibile in documenti di acquisto
  visibleInSale     Boolean @default(true) // Visibile in documenti di vendita
  visibleInInternal Boolean @default(true) // Visibile in documenti interni
  
  active         Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  products       Product[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([organizationId, active])
}

/// *
///  * UnitOfMeasure: Unità di misura
///  * 
///  * Gestisce le unità di misura per prodotti e documenti.
///  * Supporta conversioni automatiche tramite measureClass e baseFactor.
///  * MULTITENANT: Ogni unità di misura appartiene a un'organizzazione
model UnitOfMeasure {
  id             String       @id @default(cuid())
  organizationId String
  code           String
  name           String
  measureClass   String
  baseFactor     Decimal      @db.Decimal(15, 6)
  active         Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([organizationId, measureClass])
  @@index([organizationId, active])
}

/// *
///  * Product: Anagrafica prodotti/servizi
///  * REGOLA IMPORTANTE: NESSUN campo 'stock'!
///  * La giacenza si calcola sommando algebricamente i StockMovement
///  * MULTITENANT: Ogni prodotto appartiene a un'organizzazione
model Product {
  id             String           @id @default(cuid())
  organizationId String
  code           String
  name           String
  description    String?
  categoryId     String?
  price          Decimal          @db.Decimal(12, 2)
  vatRateId      String?
  
  // Magazzino predefinito per questo prodotto
  // Quando si crea un documento, se la riga non ha warehouseId specifico,
  // viene usato questo magazzino (priorità sul mainWarehouseId del documento)
  defaultWarehouseId String? // Magazzino predefinito per il prodotto
  defaultWarehouse   Warehouse? @relation(fields: [defaultWarehouseId], references: [id], onDelete: SetNull)
  
  active         Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  typeId         String?
  documentLines  DocumentLine[]
  category       ProductCategory? @relation(fields: [categoryId], references: [id])
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  type           ProductType?     @relation(fields: [typeId], references: [id])
  vatRate        VatRate?         @relation(fields: [vatRateId], references: [id])
  stockMovements StockMovement[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([organizationId, name])
  @@index([categoryId])
  @@index([typeId])
  @@index([defaultWarehouseId])
}

/// *
///  * Warehouse: Magazzini fisici
///  * MULTITENANT: Ogni magazzino appartiene a un'organizzazione
model Warehouse {
  id             String          @id @default(cuid())
  organizationId String
  code           String
  name           String
  address        String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  stockMovements StockMovement[]
  products       Product[]       // Prodotti con questo magazzino predefinito
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, code])
  @@index([organizationId])
}

/// *
///  * StockMovement: Movimenti di magazzino
///  * REGOLA FONDAMENTALE: La giacenza NON è un campo, ma la SOMMA di questi movimenti
///  * - quantity > 0 = CARICO
///  * - quantity < 0 = SCARICO
///  * La giacenza attuale si ottiene: SUM(quantity) GROUP BY (productId, warehouseId)
///  * MULTITENANT: Ogni movimento appartiene a un'organizzazione
model StockMovement {
  id             String              @id @default(cuid())
  organizationId String
  productId      String
  warehouseId    String
  quantity       Decimal             @db.Decimal(12, 4)
  type           MovementType
  documentId     String?
  documentNumber String?
  notes          String?
  userId         String?
  createdAt      DateTime            @default(now())
  documentTypeId String?
  documentType   DocumentTypeConfig? @relation(fields: [documentTypeId], references: [id])
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  product        Product             @relation(fields: [productId], references: [id])
  warehouse      Warehouse           @relation(fields: [warehouseId], references: [id])

  @@index([organizationId])
  @@index([organizationId, productId])
  @@index([organizationId, warehouseId])
  @@index([organizationId, createdAt])
  @@index([organizationId, documentId])
  @@index([organizationId, documentTypeId])
}

/// *
///  * DocumentTypeConfig: Configurazione tipi documento configurabili
///  * 
///  * Permette di configurare i tipi di documento con flag per:
///  * - Movimentazione magazzino (inventoryMovement)
///  * - Impatto su costi/ricavi (valuationImpact)
///  * - Segno operazione (operationSign: +1 incremento, -1 decremento)
///  * - Numerazione separata (numeratorCode)
///  * - Direzione documento (documentDirection: PURCHASE, SALE, INTERNAL)
///  * 
///  * MULTITENANT: Ogni configurazione appartiene a un'organizzazione
model DocumentTypeConfig {
  id                     String          @id @default(cuid())
  organizationId         String
  code                   String
  description            String
  numeratorCode          String
  inventoryMovement      Boolean         @default(false)
  valuationImpact        Boolean         @default(false)
  documentDirection      String          @default("SALE") // PURCHASE, SALE, INTERNAL
  active                 Boolean         @default(true)
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  operationSignStock     Int?
  operationSignValuation Int?
  documents              Document[]
  organization           Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stockMovements         StockMovement[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([organizationId, active])
  @@index([organizationId, numeratorCode])
  @@index([organizationId, documentDirection])
}

/// *
///  * Document: Documento commerciale unificato
///  * REGOLA SNAPSHOT: Tutti i dati del cliente sono COPIATI (snapshot) al momento
///  * della creazione. Se domani il cliente cambia indirizzo, questo documento
///  * mantiene l'indirizzo originale.
///  * IMPORTANTE: Supporta più tipi di documento (preventivo, ordine, DDT, fattura, nota credito)
///  * MULTITENANT: Ogni documento appartiene a un'organizzazione
model Document {
  id                         String             @id @default(cuid())
  organizationId             String
  number                     String
  date                       DateTime
  entityId                   String?
  customerNameSnapshot       String
  customerVatSnapshot        String?
  customerFiscalCodeSnapshot String?
  customerAddressSnapshot    String
  customerSdiSnapshot        String?
  customerCity               String
  customerProvince           String
  customerZip                String
  customerCountry            String             @default("IT")
  netTotal                   Decimal            @db.Decimal(12, 2)
  vatTotal                   Decimal            @db.Decimal(12, 2)
  grossTotal                 Decimal            @db.Decimal(12, 2)
  notes                      String?
  paymentTerms               String?
  paymentConditionId            String?
  
  // ✅ Codici per fatture verso PA (obbligatori per FatturaPA)
  codiceCIG                  String?            // Codice Identificativo Gara
  codiceCUP                  String?            // Codice Unico Progetto
  
  createdAt                  DateTime           @default(now())
  updatedAt                  DateTime           @updatedAt
  category                   DocumentCategory
  documentTypeId             String
  documentType               DocumentTypeConfig @relation(fields: [documentTypeId], references: [id])
  entity                     Entity?            @relation(fields: [entityId], references: [id])
  organization               Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  paymentCondition           PaymentCondition?  @relation(fields: [paymentConditionId], references: [id])
  lines                      DocumentLine[]
  paymentDeadlines           PaymentDeadline[]

  @@unique([organizationId, number])
  @@index([organizationId])
  @@index([organizationId, date])
  @@index([organizationId, entityId])
  @@index([organizationId, category])
  @@index([organizationId, documentTypeId])
  @@index([paymentConditionId])
}

/// *
///  * DocumentLine: Riga di documento
///  * REGOLA SNAPSHOT: Anche qui, TUTTI i dati del prodotto sono copiati.
///  * Se domani il prezzo del prodotto cambia, questa riga mantiene il prezzo originale.
model DocumentLine {
  id          String   @id @default(cuid())
  documentId  String
  productId   String?
  productCode String
  description String
  unitPrice   Decimal  @db.Decimal(12, 2)
  quantity    Decimal  @db.Decimal(12, 4)
  vatRateId   String?
  vatRate     Decimal  @db.Decimal(5, 4)
  netAmount   Decimal  @db.Decimal(12, 2)
  vatAmount   Decimal  @db.Decimal(12, 2)
  grossAmount Decimal  @db.Decimal(12, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  product     Product? @relation(fields: [productId], references: [id])
  vatRateRef  VatRate? @relation(fields: [vatRateId], references: [id])

  @@index([documentId])
  @@index([productId])
  @@index([vatRateId])
}

enum UserRole {
  OWNER
  ADMIN
  USER
  READONLY
}

enum EntityType {
  CLIENT
  PROVIDER
  BOTH
}

enum MovementType {
  CARICO_INIZIALE
  CARICO_FORNITORE
  SCARICO_VENDITA
  SCARICO_DDT
  RETTIFICA_INVENTARIO
  RESO_CLIENTE
  RESO_FORNITORE
  TRASFERIMENTO_USCITA
  TRASFERIMENTO_ENTRATA
}

/// *
///  * PaymentType: Anagrafica metodi di pagamento (SDI/SEPA compliant)
///  * 
///  * SEPARA il "come" si paga (Bonifico, RiBa, Assegno, etc.) dalla
///  * condizione di pagamento (il "quando" si paga).
///  * 
///  * REGOLE:
///  * - sdiCode: Codice MPxx obbligatorio per fatturazione elettronica (es. MP05 per Bonifico)
///  * - sepaCode: Codice per flussi bancari SEPA (es. TRF per Bonifico, OXI per RiBa)
///  * - MULTITENANT: Ogni tipo di pagamento appartiene a un'organizzazione
///  * 
///  * CODICI SDI STANDARD:
///  * - MP01: Contanti
///  * - MP02: Assegno
///  * - MP03: Assegno circolare
///  * - MP04: Contanti presso Tesoreria
///  * - MP05: Bonifico
///  * - MP06: Vaglia cambiario
///  * - MP07: Bollettino bancario
///  * - MP08: Carta di pagamento
///  * - MP09: RID
///  * - MP10: RID utenze
///  * - MP11: RID veloce
///  * - MP12: RiBa
///  * - MP13: MAV
///  * - MP14: Quietanza erario
///  * - MP15: Giroconto su conti di contabilità speciale
///  * - MP16: Domiciliazione bancaria
///  * - MP17: Domiciliazione postale
///  * - MP18: Bollettino di c/c postale
///  * - MP19: SEPA Direct Debit
///  * - MP20: SEPA Direct Debit CORE
///  * - MP21: SEPA Direct Debit B2B
///  * - MP22: Trattenuta su somme già riscosse
///  * - MP23: PagoPA
model PaymentType {
  id              String             @id @default(cuid())
  organizationId  String
  name            String             // es: "Bonifico Bancario"
  sdiCode         String             // Codice MPxx (es: MP05 per Bonifico, MP12 per RIBA)
  sepaCode        String?            // Codice TRF (Bonifico) o OXI (RiBa) per flussi bancari
  active          Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  organization    Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conditions      PaymentCondition[]

  @@unique([organizationId, sdiCode])
  @@index([organizationId])
  @@index([organizationId, active])
}

/// *
///  * PaymentCondition: Condizione di pagamento (logica di calcolo scadenze)
///  * 
///  * SEPARA il "quando" si paga dalla modalità (il "come").
///  * 
///  * REGOLE:
///  * - daysToFirstDue: Giorni dalla data base alla prima scadenza
///  * - gapBetweenDues: Giorni tra una scadenza e la successiva
///  * - numberOfDues: Numero di rate (default: 1 = pagamento unico)
///  * - isEndOfMonth: Se true, sposta le scadenze all'ultimo giorno del mese
///  * - MULTITENANT: Ogni condizione appartiene a un'organizzazione
///  * 
///  * ESEMPI:
///  * - "30 gg FM": daysToFirstDue=30, numberOfDues=1, isEndOfMonth=true
///  * - "30/60 gg": daysToFirstDue=30, gapBetweenDues=30, numberOfDues=2
///  * - "Immediato": daysToFirstDue=0, numberOfDues=1
model PaymentCondition {
  id              String             @id @default(cuid())
  organizationId  String
  name            String             // es: "30/60 gg FM"
  paymentTypeId   String
  daysToFirstDue Int                 @default(0)
  gapBetweenDues Int                 @default(0)
  numberOfDues    Int                 @default(1)
  isEndOfMonth    Boolean            @default(false)
  active          Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  paymentType     PaymentType        @relation(fields: [paymentTypeId], references: [id])
  organization    Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents       Document[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([organizationId, paymentTypeId])
  @@index([organizationId, active])
}

/// *
///  * PaymentDeadline: Scadenze reali generate sui documenti (SNAPSHOT)
///  * 
///  * REGOLA SNAPSHOT: Le scadenze sono calcolate al momento della creazione del documento
///  * e memorizzate come snapshot. Se domani la PaymentCondition cambia, le scadenze
///  * del documento rimangono invariate.
///  * 
///  * REGOLE:
///  * - amount: Importo della scadenza (rigorosamente Decimal)
///  * - status: PENDING, PAID, PARTIAL
///  * - paidAmount: Importo già pagato (per gestire pagamenti parziali)
///  * - MULTITENANT: Implicito tramite documentId -> organizationId
model PaymentDeadline {
  id          String   @id @default(cuid())
  documentId  String
  dueDate     DateTime
  amount      Decimal  @db.Decimal(12, 2)
  status      String   @default("PENDING") // PENDING, PAID, PARTIAL
  paidAmount  Decimal  @default(0) @db.Decimal(12, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([dueDate])
  @@index([status])
}

/// *
///  * StandardConfig: Configurazioni standard (Super Admin)
///  * 
///  * Gestisce le configurazioni standard che vengono caricate quando
///  * un'organizzazione usa i pulsanti "Carica Standard":
///  * - Aliquote IVA standard (VAT_RATES)
///  * - Unità di misura standard (UNITS_OF_MEASURE)
///  * - Tipi documento standard (DOCUMENT_TYPES)
///  * 
///  * NOTA: Queste configurazioni sono GLOBALI (non multitenant) e gestite solo dal Super Admin
model StandardConfig {
  id          String            @id @default(cuid())
  type        String            // 'VAT_RATES' | 'UNITS_OF_MEASURE' | 'DOCUMENT_TYPES'
  data        Json              // Dati della configurazione (JSON)
  version     Int               @default(1)
  description String?
  active      Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([type])
  @@index([type, active])
  @@index([type, version])
}

/// *
///  * DocumentCategory: Categoria documento per logiche di sistema hardcoded
///  * 
///  * Mantenuto come enum per compatibilità con logiche di sistema che richiedono
///  * un enum fisso. La configurazione completa è in DocumentTypeConfig.
enum DocumentCategory {
  QUOTE
  ORDER
  DELIVERY_NOTE
  INVOICE
  CREDIT_NOTE
}
